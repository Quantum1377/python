import fastf1
from fastf1 import plotting
from matplotlib import pyplot as plt
import math

# ===== CONFIGURA√á√ïES =====
ANO = 2025
GP = 'Brasil'
SESSAO = 'R'              # 'R' = corrida, 'Q' = qualifica√ß√£o, 'S' = treino
PILOTOS = ['VER', 'NOR']  # Coloque os c√≥digos dos pilotos. [] = todos os pilotos
MAX_SUBPLOTS_PER_PAGE = 9  # M√°ximo de gr√°ficos por p√°gina

# ===== CARREGA SESS√ÉO =====
print(f"üîÑ Carregando dados da sess√£o {GP} {ANO} ({SESSAO})...")
session = fastf1.get_session(ANO, GP, SESSAO)
session.load()

# ===== CONFIGURA√á√ÉO DO MATPLOTLIB =====
plotting.setup_mpl()

# ===== TODAS AS VARI√ÅVEIS DE TELEMETRIA POSS√çVEIS =====
telemetry_vars = [
    'Speed', 'nGear', 'RPM', 'Throttle', 'Brake', 'Steer',
    'gLong', 'gLat',
    'DRS', 'DRSRequested',
    'BrakeBias', 'FuelLevel',
    'ERSTotalEnergy', 'ERSBatteryStore', 'ERSDeployMode',
    'TyreTempFL', 'TyreTempFR', 'TyreTempRL', 'TyreTempRR',
    'TyrePressureFL', 'TyrePressureFR', 'TyrePressureRL', 'TyrePressureRR',
    'BrakeTempFL', 'BrakeTempFR', 'BrakeTempRL', 'BrakeTempRR',
    'BrakeTempCyl1', 'BrakeTempCyl2', 'BrakeTempCyl3', 'BrakeTempCyl4', 'BrakeTempCyl5',
    'BrakeTempCenter',
    'FuelFlow', 'BatteryTemperature', 'Clutch',
    'SuspensionPositionFL', 'SuspensionPositionFR', 'SuspensionPositionRL', 'SuspensionPositionRR',
    'SteerSpeed', 'Distance'
]

# ===== PILOTOS =====
pilotos = PILOTOS if PILOTOS else session.drivers

# ===== COLETA TELEMETRIA DE CADA PILOTO =====
pilot_data = {}
for driver in pilotos:
    driver_laps = session.laps.pick_driver(driver)
    
    # Escolhe a primeira volta com telemetria dispon√≠vel
    lap = None
    for l in driver_laps.iterlaps():
        try:
            data = l[1].get_car_data()
            if not data.empty:
                lap = l[1]
                break
        except Exception:
            continue
    
    if lap is None:
        print(f"‚ö†Ô∏è Nenhuma telemetria dispon√≠vel para {driver}")
        continue
    
    pilot_data[driver] = lap.get_car_data().add_distance()

if not pilot_data:
    print("‚ö†Ô∏è Nenhum piloto com telemetria dispon√≠vel. Encerrando script.")
    exit()

# ===== IDENTIFICA VARI√ÅVEIS DISPON√çVEIS EM TODOS OS PILOTOS =====
available_vars = []
for var in telemetry_vars:
    for driver in pilot_data:
        if var in pilot_data[driver].columns:
            available_vars.append(var)
            break  # se pelo menos um piloto tem a vari√°vel, inclu√≠mos
if not available_vars:
    print("‚ö†Ô∏è Nenhuma vari√°vel de telemetria dispon√≠vel para os pilotos selecionados.")
    exit()

# ===== PAGINA√á√ÉO =====
pages = [available_vars[i:i+MAX_SUBPLOTS_PER_PAGE] for i in range(0, len(available_vars), MAX_SUBPLOTS_PER_PAGE)]

# ===== PLOTAGEM =====
for page_num, vars_page in enumerate(pages, 1):
    rows = math.ceil(len(vars_page)/3)
    fig, axes = plt.subplots(rows, 3, figsize=(6*3, 4*rows), constrained_layout=True)
    axes = axes.flatten()
    
    for i, var in enumerate(vars_page):
        plotted = False
        for driver in pilot_data:
            if var in pilot_data[driver].columns:
                axes[i].plot(pilot_data[driver]['Distance'], pilot_data[driver][var], label=driver)
                plotted = True
        axes[i].set_ylabel(var)
        axes[i].grid(True)
        if plotted:
            axes[i].legend(fontsize=8)
    
    # Remove subplots extras vazios
    for j in range(len(vars_page), len(axes)):
        fig.delaxes(axes[j])
    
    axes[-1].set_xlabel('Dist√¢ncia (m)')
    fig.suptitle(f'Telemetria ‚Äì GP {GP} {ANO} ({SESSAO}) ‚Äì P√°gina {page_num}', fontsize=16)
    
    # Exibe a figura
    plt.show()

